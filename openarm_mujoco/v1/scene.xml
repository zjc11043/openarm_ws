<mujoco model="openarm_bimanual scene">
<option timestep="0.002" iterations="50" solver="Newton" tolerance="1e-4" impratio="10">
    <flag contact="enable" energy="enable"/>
</option>

  <include file="openarm_bimanual_cam_v3.xml"/>
  <!-- <include file="openarm_bimanual_cam_v2.xml"/> -->
  <!-- <include file="openarm_bimanual.xml"/> -->
  <!-- 修正点：去掉 "..."，明确指定重力和求解参数 -->
  <!-- timestep="0.002" 表示 2ms 一个步长，比默认的 1ms 快一倍 -->
  <!-- iterations="50" 限制求解器迭代次数，防止计算死锁，提高速度 -->
   <!-- 添加以下 option 配置 -->
  <!-- <option integrator="RK4" timestep="0.001" iterations="100">
    <flag contact="enable" frictionloss="enable"/>
  </option> -->
  <option timestep="0.001"  iterations="200" integrator="implicitfast" solver="Newton" tolerance="1e-10" impratio="10">
    <flag contact="enable" frictionloss="enable" energy="enable"/>
  </option>

  <statistic center="0 0 0.43" extent=".85" meansize="0.05"/>

  <visual>
    <headlight diffuse="0.6 0.6 0.6" ambient="0.3 0.3 0.3" specular="0 0 0"/>
    <rgba haze="0.15 0.25 0.35 1"/>
    <global azimuth="160" elevation="-10"/>
    <quality shadowsize="8192"/>
  </visual>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1="0.3 0.5 0.7" rgb2="0 0 0" width="512" height="3072"/>
    <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="0.2 0.3 0.4" rgb2="0.1 0.2 0.3"
      markrgb="0.8 0.8 0.8" width="300" height="300"/>
    <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5" reflectance="0.2"/>

    <texture name="tex_banana" type="2d" file="meshes/011_banana/texture_map.png"/>
    <material name="mat_banana" texture="tex_banana" specular="0.5" shininess="0.5"/>
    <mesh name="mesh_banana_visual" file="011_banana/textured_simple.obj"/>
    <mesh name="mesh_banana_collision" file="011_banana/textured_simple.obj"/>
  </asset>

  <worldbody>
    <light pos="0 0 1.5" dir="0 0 -1" directional="true"/>
    <geom name="floor" size="0 0 0.05" type="plane" material="groundplane"/>

    <body name="table" pos="0.35 0 0.15">
      <!-- 
        type="box": 盒子形状
        size="0.25 0.3 0.15": 半长宽高（全长为 0.5m x 0.6m x 0.3m）
        friction="1 0.005 0.0001": 设置摩擦力（滑动、扭转、滚动）- 1.0 是比较强的摩擦，防止物体乱滑
        contype="1": 自身的碰撞类型标识
        conaffinity="1": 允许与哪些类型的物体发生碰撞
        condim="3": 设置接触动力学维度。3表示普通摩擦接触，4表示增加抗扭转摩擦（抓取仿真常用）
        增加margin="0.001"以防止香蕉穿模
      -->
      <geom name="table_top" 
            type="box" 
            size="0.25 0.3 0.15" 
            rgba="0.8 0.8 0.8 1"
            friction="1 0.005 0.0001" 
            contype="1" 
            conaffinity="1" 
            condim="3"
            margin="0.001"/>
    </body>

    <body name="banana" pos="0.35 0 0.35" euler="0 0 1.57">
      <joint name="banana_joint" type="free" damping="0.5" frictionloss="0.05"/> 
      <!-- 1. 视觉模型：保持 contype/conaffinity 为 0，通常放在 group 1 (渲染组) -->
      <geom type="mesh" mesh="mesh_banana_visual" material="mat_banana" 
            contype="0" conaffinity="0" group="1" condim="4" />
      <!-- 
        惯性参数修正：香蕉碰撞体是胶囊形（capsule size="0.02 0.06"），
        需要根据胶囊形状计算正确的转动惯量，而不是使用各向同性的极小值。
        胶囊：半径r=0.02m，半长度h=0.06m（总长度L=0.12m），质量m=0.2kg
        由于euler="1.57 0 0"（绕x轴旋转90度），胶囊长轴在y方向：
        - 沿长轴（y轴）：I_y = m * r^2 / 2 = 0.2 * 0.02^2 / 2 = 0.00004
        - 沿短轴（x/z轴）：I_x = I_z = m * (3*r^2 + L^2) / 12 = 0.2 * (3*0.0004 + 0.0144) / 12 ≈ 0.00026
      -->
      <inertial pos="0 0 0" mass="0.2" diaginertia="0.00026 0.00004 0.00026"/> 
      <!-- 大幅增加摩擦系数以防止滑动：滑动摩擦、扭转摩擦和滚动摩擦都大幅增加 -->
      <!-- 增加margin防止穿模，增加摩擦系数以更好地被夹手抓住 -->
      <geom type="capsule" size="0.02 0.06" euler="1.57 0 0" pos="0 0 0" 
          contype="1" conaffinity="1" 
          friction="5.0 0.5 0.1" 
          solref="0.02 1" 
          solimp="0.9 0.95 0.001" 
          margin="0.005"
          group="3" />
      <!-- <geom type="box" size="0.02 0.07 0.02" pos="0 0 0" 
          contype="1" conaffinity="1" 
          friction="2.0 0.1 0.002" 
          solref="0.01 1" solimp="0.9 0.98 0.001" /> -->
      <!-- <geom type="mesh" mesh="mesh_banana_collision" 
        contype="1" conaffinity="1" 
        friction="0.8 0.02 0.01"
        solref="0.02 1.5" solimp="0.1 0.8 0.01" /> -->
    </body>
      <!-- 2. 碰撞模型：必须开启碰撞属性，通常放在 group 3 (碰撞组) -->
      <!-- 建议去掉 contype="0" conaffinity="0" (默认就是 1) -->
      <!-- mass 属性很重要，决定了它掉落后的惯性 -->
      <!-- <geom type="mesh" mesh="mesh_banana_collision" 
        contype="1" conaffinity="1" 
        friction="0.8 0.02 0.01"
        solref="0.02 1.5" solimp="0.1 0.8 0.01" /> -->
    
    <!-- <body name="banana" pos="0.35 0 0.35">
      <freejoint/>
      <geom type="box" size="0.02 0.02 0.02" rgba="1 0 0 1" mass="0.1" friction="1.0 0.005 0.00001"/>
    </body> -->
    <!-- <body name="apple" pos="0.4 0.03 0.45">
        <freejoint/>
        <geom type="sphere" size="0.03" rgba="1 0 0 1" mass="0.1" friction="1 0.005 0.0001"/>
    </body> -->
  </worldbody>
</mujoco>
